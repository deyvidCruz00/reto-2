<div class="control-acceso-container">
  <h1>Control de Acceso</h1>

  <div class="content-grid">
    <!-- Panel de Registro -->
    <mat-card class="register-panel">
      <mat-card-header>
        <mat-icon mat-card-avatar>badge</mat-icon>
        <mat-card-title>Registrar Acceso</mat-card-title>
        <mat-card-subtitle>Entrada / Salida de Empleados</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Número de Documento</mat-label>
          <input matInput [(ngModel)]="documentNumber" (keyup.enter)="searchEmployee()" placeholder="Ingrese el documento">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        @if (selectedEmployee()) {
          <div class="employee-info">
            <mat-icon class="employee-icon">person</mat-icon>
            <div class="employee-details">
              <h3>{{ selectedEmployee()!.firstName }} {{ selectedEmployee()!.lastName }}</h3>
              <p>Documento: {{ selectedEmployee()!.documentNumber }}</p>
              <p>Email: {{ selectedEmployee()!.email }}</p>
              <mat-chip [class]="selectedEmployee()!.status ? 'active-chip' : 'inactive-chip'">
                {{ selectedEmployee()!.status ? 'Activo' : 'Inactivo' }}
              </mat-chip>
            </div>
          </div>

          <div class="action-buttons">
            <button mat-raised-button color="primary" (click)="checkIn()" 
                    [disabled]="!selectedEmployee()!.status || processingAccess()" class="full-width">
              <mat-icon>login</mat-icon>
              Registrar Entrada
            </button>
            <button mat-raised-button color="accent" (click)="checkOut()" 
                    [disabled]="!selectedEmployee()!.status || processingAccess()" class="full-width">
              <mat-icon>logout</mat-icon>
              Registrar Salida
            </button>
          </div>
        } @else if (searchPerformed()) {
          <div class="no-employee">
            <mat-icon>person_off</mat-icon>
            <p>Empleado no encontrado</p>
          </div>
        }

        @if (processingAccess()) {
          <div class="processing">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Procesando...</span>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Panel de Estadísticas -->
    <mat-card class="stats-panel">
      <mat-card-header>
        <mat-icon mat-card-avatar class="success-icon">people</mat-icon>
        <mat-card-title>Empleados Dentro</mat-card-title>
        <mat-card-subtitle>En las instalaciones ahora</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <h2 class="count">{{ employeesInside() }}</h2>
        
        @if (employeesInsideList().length > 0) {
          <div class="employees-inside-list">
            @for (access of employeesInsideList(); track access.employeeDocumentNumber) {
              <div class="inside-item">
                <mat-icon class="entry-icon">login</mat-icon>
                <div class="inside-info">
                  <p class="doc-number">{{ access.employeeDocumentNumber }}</p>
                  <p class="entry-time">Entrada: {{ formatTime(access.entry_datetime) }}</p>
                </div>
              </div>
            }
          </div>
        } @else {
          <p class="no-data">No hay empleados dentro</p>
        }
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Historial de Accesos -->
  <mat-card class="history-card">
    <mat-card-header>
      <mat-icon mat-card-avatar>history</mat-icon>
      <mat-card-title>Historial de Accesos</mat-card-title>
      <mat-card-subtitle>Registros de hoy</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="filters">
        <mat-form-field appearance="outline">
          <mat-label>Fecha Inicio</mat-label>
          <input matInput [matDatepicker]="pickerStart" [(ngModel)]="dateStart" (ngModelChange)="loadAccessHistory()">
          <mat-datepicker-toggle matIconSuffix [for]="pickerStart"></mat-datepicker-toggle>
          <mat-datepicker #pickerStart></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Fecha Fin</mat-label>
          <input matInput [matDatepicker]="pickerEnd" [(ngModel)]="dateEnd" (ngModelChange)="loadAccessHistory()">
          <mat-datepicker-toggle matIconSuffix [for]="pickerEnd"></mat-datepicker-toggle>
          <mat-datepicker #pickerEnd></mat-datepicker>
        </mat-form-field>
      </div>

      @if (loadingHistory()) {
        <div class="loading-container">
          <mat-spinner></mat-spinner>
        </div>
      } @else {
        <div class="table-container">
          <table mat-table [dataSource]="accessHistory()" class="access-table">
            <ng-container matColumnDef="documentNumber">
              <th mat-header-cell *matHeaderCellDef>Documento</th>
              <td mat-cell *matCellDef="let access">{{ access.employeeDocumentNumber }}</td>
            </ng-container>

            <ng-container matColumnDef="entry">
              <th mat-header-cell *matHeaderCellDef>Entrada</th>
              <td mat-cell *matCellDef="let access">
                <div class="datetime-cell">
                  <mat-icon class="entry-icon">login</mat-icon>
                  {{ formatDateTime(access.entry_datetime) }}
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="exit">
              <th mat-header-cell *matHeaderCellDef>Salida</th>
              <td mat-cell *matCellDef="let access">
                @if (access.exit_datetime) {
                  <div class="datetime-cell">
                    <mat-icon class="exit-icon">logout</mat-icon>
                    {{ formatDateTime(access.exit_datetime) }}
                  </div>
                } @else {
                  <mat-chip class="inside-chip">Dentro</mat-chip>
                }
              </td>
            </ng-container>

            <ng-container matColumnDef="duration">
              <th mat-header-cell *matHeaderCellDef>Duración</th>
              <td mat-cell *matCellDef="let access">
                {{ calculateDuration(access.entry_datetime, access.exit_datetime) }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: historyColumns;"></tr>
          </table>

          @if (accessHistory().length === 0) {
            <div class="no-data">
              <mat-icon>event_busy</mat-icon>
              <p>No hay registros en este período</p>
            </div>
          }
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>
